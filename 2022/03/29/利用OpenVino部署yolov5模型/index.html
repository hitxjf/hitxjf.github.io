<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>利用OpenVino部署yolov5模型 | JiaFan's Blog</title><meta name="author" content="Fun"><meta name="copyright" content="Fun"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="利用OpenVino部署yolov5模型训练好的yolov5模型想部署在NUC小电脑的Ubuntu环境上，这里我们选择OpenVINO工具进行部署。OpenVINO是英特尔推出的一款全面的工具套件，用于快速部署应用和解决方案。 1. OpenVINO的安装首先进入OpenVINO官网下载安装包【下载地址】，按如下选择版本。你可能会问为什么不选择2022的最新版本呢？因为2022.1的安装方式和之前">
<meta property="og:type" content="article">
<meta property="og:title" content="利用OpenVino部署yolov5模型">
<meta property="og:url" content="http://example.com/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/index.html">
<meta property="og:site_name" content="JiaFan&#39;s Blog">
<meta property="og:description" content="利用OpenVino部署yolov5模型训练好的yolov5模型想部署在NUC小电脑的Ubuntu环境上，这里我们选择OpenVINO工具进行部署。OpenVINO是英特尔推出的一款全面的工具套件，用于快速部署应用和解决方案。 1. OpenVINO的安装首先进入OpenVINO官网下载安装包【下载地址】，按如下选择版本。你可能会问为什么不选择2022的最新版本呢？因为2022.1的安装方式和之前">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/cover9_yolov5.jpg">
<meta property="article:published_time" content="2022-03-29T14:00:00.000Z">
<meta property="article:modified_time" content="2022-03-29T17:54:31.570Z">
<meta property="article:author" content="Fun">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/cover9_yolov5.jpg"><link rel="shortcut icon" href="/img/ironman.png"><link rel="canonical" href="http://example.com/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '利用OpenVino部署yolov5模型',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-30 01:54:31'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const fontSizeVal = saveToLocal.get('global-font-size')
    if (fontSizeVal !== undefined) {
      document.documentElement.style.setProperty('--global-font-size', fontSizeVal + 'px')
    }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.0.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/cover9_yolov5.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">JiaFan's Blog</a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">利用OpenVino部署yolov5模型</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-29T14:00:00.000Z" title="发表于 2022-03-29 22:00:00">2022-03-29</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-29T17:54:31.570Z" title="更新于 2022-03-30 01:54:31">2022-03-30</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">3.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="利用OpenVino部署yolov5模型"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="利用OpenVino部署yolov5模型"><a href="#利用OpenVino部署yolov5模型" class="headerlink" title="利用OpenVino部署yolov5模型"></a>利用OpenVino部署yolov5模型</h1><p>训练好的yolov5模型想部署在NUC小电脑的Ubuntu环境上，这里我们选择OpenVINO工具进行部署。OpenVINO是英特尔推出的一款全面的工具套件，用于快速部署应用和解决方案。</p>
<h2 id="1-OpenVINO的安装"><a href="#1-OpenVINO的安装" class="headerlink" title="1. OpenVINO的安装"></a>1. OpenVINO的安装</h2><p>首先进入OpenVINO官网下载安装包【<a target="_blank" rel="noopener" href="https://www.intel.com/content/www/us/en/developer/tools/openvino-toolkit/download.html">下载地址</a>】，按如下选择版本。你可能会问为什么不选择2022的最新版本呢？因为2022.1的安装方式和之前有所变化，现在网上对于新版的博客资源较少，这里我们选择2021.4.2是较为稳妥的方式，有问题一般都可以在前人的博客中找到答案（bushi，其实就是我太菜…）。</p>
<p><img src="/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/1.png" alt="aaa"></p>
<h4 id="Step1-下载完成后，解压安装包，"><a href="#Step1-下载完成后，解压安装包，" class="headerlink" title="Step1 下载完成后，解压安装包，"></a>Step1 下载完成后，解压安装包，</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在终端中打开, 使用带安装界面的安装脚本</span><br><span class="line">sudo ./install_GUI.sh</span><br></pre></td></tr></table></figure>
<p>依次勾选接收协议，拒绝收集信息，继续安装。安装过程中可能会提示没找到显卡，发现另一个OpenCV等信息，不用管它。</p>
<h4 id="Step2-安装依赖"><a href="#Step2-安装依赖" class="headerlink" title="Step2 安装依赖"></a>Step2 安装依赖</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /opt/intel/openvino_2021.4.752/install_dependencies</span><br><span class="line">sudo -E ./install_openvino_dependencies.sh</span><br></pre></td></tr></table></figure>
<h4 id="Step3-环境变量设置"><a href="#Step3-环境变量设置" class="headerlink" title="Step3 环境变量设置"></a>Step3 环境变量设置</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo gedit ~/.bashrc</span><br><span class="line">加入source /opt/intel/openvino_2021.4.752/bin/setupvars.sh</span><br></pre></td></tr></table></figure>
<h4 id="Step4-测试是否安装成功"><a href="#Step4-测试是否安装成功" class="headerlink" title="Step4 测试是否安装成功"></a>Step4 测试是否安装成功</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd //opt/intel/openvino_2021.4.752/deployment_tools/demo</span><br><span class="line">./demo_security_barrier_camera.sh (测试cpu环境)</span><br><span class="line">./demo_security_barrier_camera.sh -d GPU(测试gpu环境)</span><br></pre></td></tr></table></figure>
<p>如果出现下面这张图片说明安装成功。</p>
<p><img src="/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/2.png" alt="aaa"></p>
<h2 id="2-yolov5模型的部署"><a href="#2-yolov5模型的部署" class="headerlink" title="2. yolov5模型的部署"></a>2. yolov5模型的部署</h2><p>部署的话需要提前导出模型为OpenVINO需要的格式 best.xml和best.bin，以下代码主要参考<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/338167520">知乎文章</a>，这篇文章作者给的代码不全，所以我这里给出完整的部署实现代码。</p>
<h4 id="2-1-CMakeLists-txt"><a href="#2-1-CMakeLists-txt" class="headerlink" title="2.1 CMakeLists.txt"></a>2.1 CMakeLists.txt</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.5</span>)</span><br><span class="line"><span class="keyword">project</span>(yolov5_openvino_cpp)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">14</span>)</span><br><span class="line"><span class="keyword">SET</span>(CMAKE_BUILD_TYPE Debug)</span><br><span class="line"><span class="keyword">set</span>(EXECUTABLE_OUTPUT_PATH <span class="variable">$&#123;PROJECT_SOURCE_DIR&#125;</span>/bin)</span><br><span class="line"><span class="keyword">include_directories</span>(</span><br><span class="line">    <span class="comment">#OpenVINO推理引擎的头文件</span></span><br><span class="line">    /opt/intel/openvino/deployment_tools/inference_engine/<span class="keyword">include</span>/</span><br><span class="line">    /opt/intel/openvino/deployment_tools/ngraph/<span class="keyword">include</span>/</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">#查找必要的依赖包</span></span><br><span class="line"><span class="keyword">find_package</span>(OpenCV <span class="number">4</span> REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(InferenceEngine_DIR <span class="string">&quot;/opt/intel/openvino/deployment_tools/inference_engine/share&quot;</span>)</span><br><span class="line"><span class="keyword">find_package</span>(InferenceEngine)</span><br><span class="line"><span class="comment"># set(ngraph_DIR &quot;/opt/intel/openvino/deployment_tools/ngraph&quot;)</span></span><br><span class="line"><span class="comment"># find_package(ngraph REQUIRED)</span></span><br><span class="line"><span class="comment"># set(ngraph_LIBRARIES &quot;/opt/intel/openvino/deployment_tools/ngraph/lib/libngraph.so&quot;)</span></span><br><span class="line"><span class="comment"># set(ngraph_INCLUDE_DIRS &quot;/opt/intel/openvino/deployment_tools/ngraph/include/&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(./backward-cpp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_library</span> (robot_detector_lib SHARED <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/RobotDetector.cpp)</span><br><span class="line"><span class="keyword">target_include_directories</span>(robot_detector_lib</span><br><span class="line">        PUBLIC <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>/<span class="keyword">include</span></span><br><span class="line">        PUBLIC <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">        PUBLIC <span class="variable">$&#123;OpenCV_INCLUDE_DIR&#125;</span></span><br><span class="line">        PUBLIC <span class="variable">$&#123;InferenceEngine_INCLUDE_DIRS&#125;</span></span><br><span class="line"><span class="comment">#        PUBLIC $&#123;ngraph_INCLUDE_DIRS&#125;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(robot_detector_lib</span><br><span class="line">        <span class="variable">$&#123;OpenCV_LIBS&#125;</span></span><br><span class="line">        <span class="variable">$&#123;InferenceEngine_LIBRARIES&#125;</span></span><br><span class="line">        <span class="variable">$&#123;ngraph_LIBRARIES&#125;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(robot_detector yolov5_openvino.cpp  <span class="variable">$&#123;BACKWARD_ENABLE&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(robot_detector</span><br><span class="line">        <span class="variable">$&#123;OpenCV_LIBS&#125;</span></span><br><span class="line">        robot_detector_lib</span><br><span class="line">        dw</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="2-2-yolov5-openvino-cpp"><a href="#2-2-yolov5-openvino-cpp" class="headerlink" title="2.2 yolov5_openvino.cpp"></a>2.2 yolov5_openvino.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;RobotDetector.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    RobotDetector* detector = <span class="keyword">new</span> RobotDetector;</span><br><span class="line">    std::string xml_path = <span class="string">&quot;../model/best.xml&quot;</span>;</span><br><span class="line">    detector-&gt;<span class="built_in">init</span>(xml_path,<span class="number">0.5</span>,<span class="number">0.5</span>);<span class="comment">//第一个0.5指预测的概率低于0.5的结果被舍弃</span></span><br><span class="line">                                     <span class="comment">//第二个0.5是NMS的参数，与得分最高的框的IOU的大于0.5被滤除</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//For Video</span></span><br><span class="line">    cv::VideoCapture capture;</span><br><span class="line">    std::string filename = <span class="string">&quot;../video/第一视角-小组赛-HITCSC-第二局.mp4&quot;</span>;	</span><br><span class="line">	capture.<span class="built_in">open</span>(filename);</span><br><span class="line">    cv::Mat src;</span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;std::string&gt; class_list = &#123;<span class="string">&quot;robot&quot;</span>,<span class="string">&quot;red1&quot;</span>,<span class="string">&quot;red2&quot;</span>,<span class="string">&quot;blue1&quot;</span>,<span class="string">&quot;blue2&quot;</span>,<span class="string">&quot;grey&quot;</span>&#125;; </span><br><span class="line">    <span class="keyword">const</span> std::vector&lt;cv::Scalar&gt; colors = &#123;cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>), cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), </span><br><span class="line">                                            cv::<span class="built_in">Scalar</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), cv::<span class="built_in">Scalar</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>), cv::<span class="built_in">Scalar</span>(<span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>)&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">auto</span> start = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="keyword">int</span> frame_count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">float</span> fps = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        capture &gt;&gt; src;</span><br><span class="line">        <span class="keyword">if</span> (src.<span class="built_in">empty</span>())</span><br><span class="line">        &#123;</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;End of stream\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        frame_count++;</span><br><span class="line">        <span class="comment">//auto start = std::chrono::high_resolution_clock::now();</span></span><br><span class="line"></span><br><span class="line">        std::vector&lt;RobotDetector::Object&gt; detected_objects;</span><br><span class="line">        detector-&gt;<span class="built_in">process_frame</span>(src,detected_objects);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// auto end = std::chrono::high_resolution_clock::now();</span></span><br><span class="line">        <span class="comment">// std::chrono::duration&lt;double&gt; diff = end - start;</span></span><br><span class="line">        <span class="comment">// std::cout&lt;&lt;&quot;use &quot;&lt;&lt;diff.count()&lt;&lt;&quot; s&quot; &lt;&lt; std::endl;</span></span><br><span class="line">        <span class="keyword">if</span> (frame_count &gt;= <span class="number">30</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">auto</span> end = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">            fps = frame_count * <span class="number">1000.0</span> / std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(end - start).<span class="built_in">count</span>();</span><br><span class="line">            frame_count = <span class="number">0</span>;</span><br><span class="line">            start = std::chrono::high_resolution_clock::<span class="built_in">now</span>();</span><br><span class="line">            std::cout&lt;&lt; <span class="string">&quot;FPS: &quot;</span> &lt;&lt; fps &lt;&lt;std::endl;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (fps &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            std::ostringstream fps_label;</span><br><span class="line">            fps_label &lt;&lt; std::fixed &lt;&lt; std::<span class="built_in">setprecision</span>(<span class="number">2</span>);</span><br><span class="line">            fps_label &lt;&lt; <span class="string">&quot;FPS: &quot;</span> &lt;&lt; fps;</span><br><span class="line">            std::string fps_label_str = fps_label.<span class="built_in">str</span>();</span><br><span class="line">            cv::<span class="built_in">putText</span>(src, fps_label_str.<span class="built_in">c_str</span>(), cv::<span class="built_in">Point</span>(<span class="number">10</span>, <span class="number">25</span>), cv::FONT_HERSHEY_SIMPLEX, <span class="number">1</span>, cv::<span class="built_in">Scalar</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>), <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; detected_objects.<span class="built_in">size</span>(); ++i)&#123;</span><br><span class="line">            <span class="keyword">int</span> xmin = detected_objects[i].box.x;</span><br><span class="line">            <span class="keyword">int</span> ymin = detected_objects[i].box.y;</span><br><span class="line">            <span class="keyword">int</span> width = detected_objects[i].box.width;</span><br><span class="line">            <span class="keyword">int</span> height = detected_objects[i].box.height;</span><br><span class="line">            <span class="function">cv::Rect <span class="title">rect</span><span class="params">(xmin, ymin, width, height)</span></span>;<span class="comment">//左上坐标（x,y）和矩形的长(x)宽(y)</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">int</span> classId = detected_objects[i].class_id;</span><br><span class="line">            cv::<span class="built_in">rectangle</span>(src, rect, colors[classId], <span class="number">1.5</span>);</span><br><span class="line">            cv::<span class="built_in">rectangle</span>(src, cv::<span class="built_in">Point</span>(xmin, ymin - <span class="number">20</span>), cv::<span class="built_in">Point</span>(xmin + width/<span class="number">3</span>, ymin), colors[classId], cv::FILLED);</span><br><span class="line">            cv::<span class="built_in">putText</span>(src, class_list[classId], cv::<span class="built_in">Point</span>(xmin, ymin - <span class="number">5</span>), cv::FONT_HERSHEY_SIMPLEX, <span class="number">0.5</span>, cv::<span class="built_in">Scalar</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cv::<span class="built_in">imshow</span>(<span class="string">&quot;cap&quot;</span>,src);</span><br><span class="line">        cv::<span class="built_in">waitKey</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//For picture</span></span><br><span class="line">    <span class="comment">// Mat src = imread(&quot;../res/125.jpg&quot;);</span></span><br><span class="line">    <span class="comment">// Mat osrc = src.clone();</span></span><br><span class="line">    <span class="comment">// resize(osrc,osrc,Size(640,640));</span></span><br><span class="line">    <span class="comment">// vector&lt;Detector::Object&gt; detected_objects;</span></span><br><span class="line">    <span class="comment">// auto start = chrono::high_resolution_clock::now();</span></span><br><span class="line">    <span class="comment">// detector-&gt;process_frame(src,detected_objects);</span></span><br><span class="line">    <span class="comment">// auto end = chrono::high_resolution_clock::now();</span></span><br><span class="line">    <span class="comment">// std::chrono::duration&lt;double&gt; diff = end - start;</span></span><br><span class="line">    <span class="comment">// cout&lt;&lt;&quot;use &quot;&lt;&lt;diff.count()&lt;&lt;&quot; s&quot; &lt;&lt; endl;</span></span><br><span class="line">    <span class="comment">// for(int i=0;i&lt;detected_objects.size();++i)&#123;</span></span><br><span class="line">    <span class="comment">//      int xmin = detected_objects[i].rect.x;</span></span><br><span class="line">    <span class="comment">//     int ymin = detected_objects[i].rect.y;</span></span><br><span class="line">    <span class="comment">//     int width = detected_objects[i].rect.width;</span></span><br><span class="line">    <span class="comment">//     int height = detected_objects[i].rect.height;</span></span><br><span class="line">    <span class="comment">//     Rect rect(xmin, ymin, width, height);//左上坐标（x,y）和矩形的长(x)宽(y)</span></span><br><span class="line">    <span class="comment">//     cv::rectangle(osrc, rect, Scalar(0, 0, 255),1, LINE_8,0);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// imshow(&quot;result&quot;,osrc);</span></span><br><span class="line">    <span class="comment">// waitKey(0);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-3-RobotDetector-h"><a href="#2-3-RobotDetector-h" class="headerlink" title="2.3 RobotDetector.h"></a>2.3 RobotDetector.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> ROBOT_DETECTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ROBOT_DETECTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/opencv.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;inference_engine.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;chrono&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;opencv2/dnn/dnn.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> InferenceEngine;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RobotDetector</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="keyword">float</span> confidence;</span><br><span class="line">            <span class="keyword">int</span> class_id;</span><br><span class="line">            cv::Rect box;</span><br><span class="line">        &#125; Object;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">RobotDetector</span>();</span><br><span class="line">        ~<span class="built_in">RobotDetector</span>();</span><br><span class="line">        <span class="comment">//初始化</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">init</span><span class="params">(std::string xml_path,<span class="keyword">double</span> cof_threshold,<span class="keyword">double</span> nms_area_threshold)</span></span>;</span><br><span class="line">        <span class="comment">//处理图像获取结果</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">process_frame</span><span class="params">(cv::Mat&amp; inframe,std::vector&lt;Object&gt; &amp;detected_objects)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        <span class="function"><span class="keyword">double</span> <span class="title">sigmoid</span><span class="params">(<span class="keyword">double</span> x)</span></span>;</span><br><span class="line">        <span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">get_anchors</span><span class="params">(<span class="keyword">int</span> net_grid)</span></span>;</span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">parseYolov5</span><span class="params">(<span class="keyword">const</span> Blob::Ptr &amp;blob,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        <span class="keyword">float</span> cof_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        std::vector&lt;cv::Rect&gt;&amp; o_rect,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        std::vector&lt;<span class="keyword">float</span>&gt;&amp; o_rect_cof,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        std::vector&lt;<span class="keyword">int</span>&gt;&amp; classId)</span></span>;</span><br><span class="line">        <span class="function">cv::Mat <span class="title">letterBox</span><span class="params">(cv::Mat src)</span></span>;</span><br><span class="line">        <span class="function">cv::Rect <span class="title">detect2origin</span><span class="params">(<span class="keyword">const</span> cv::Rect&amp; dete_rect, <span class="keyword">float</span> rate_to, <span class="keyword">int</span> top, <span class="keyword">int</span> left)</span></span>;</span><br><span class="line">        <span class="comment">//存储初始化获得的可执行网络</span></span><br><span class="line">        ExecutableNetwork _network;</span><br><span class="line">        OutputsDataMap _outputinfo;</span><br><span class="line">        std::string _input_name;</span><br><span class="line">        <span class="comment">//参数区</span></span><br><span class="line">        std::string _xml_path;                             <span class="comment">//OpenVINO模型xml文件路径</span></span><br><span class="line">        <span class="keyword">double</span> _cof_threshold;       <span class="comment">//置信度阈值,计算方法是框置信度乘以物品种类置信度</span></span><br><span class="line">        <span class="keyword">double</span> _nms_area_threshold;  <span class="comment">//nms最小重叠面积阈值</span></span><br><span class="line">        <span class="keyword">float</span> _ratio;</span><br><span class="line">        <span class="keyword">int</span> _topPad;</span><br><span class="line">        <span class="keyword">int</span> _btmPad;</span><br><span class="line">        <span class="keyword">int</span> _leftPad;</span><br><span class="line">        <span class="keyword">int</span> _rightPad;</span><br><span class="line">        <span class="comment">// std::vector&lt;std::string&gt; _classes;</span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="2-4-RobotDetector-cpp"><a href="#2-4-RobotDetector-cpp" class="headerlink" title="2.4 RobotDetector.cpp"></a>2.4 RobotDetector.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;RobotDetector.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_LEN_F 640.0f</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IMAGE_LEN   640</span></span><br><span class="line"></span><br><span class="line">RobotDetector::<span class="built_in">RobotDetector</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line">RobotDetector::~<span class="built_in">RobotDetector</span>()&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RobotDetector::init</span><span class="params">(std::string xml_file, <span class="keyword">double</span> cof_threshold, <span class="keyword">double</span> nms_area_threshold)</span></span>&#123;</span><br><span class="line">    _xml_path = xml_file;</span><br><span class="line">    _cof_threshold = cof_threshold;</span><br><span class="line">    _nms_area_threshold = nms_area_threshold;</span><br><span class="line">    <span class="comment">// std::string ids[]=&#123;&quot;robot&quot;,&quot;red1&quot;,&quot;red2&quot;,&quot;blue1&quot;,&quot;blue2&quot;,&quot;grey&quot;&#125;; </span></span><br><span class="line">    <span class="comment">// _classes = std::vector&lt;std::string&gt;(ids, ids+6);</span></span><br><span class="line">    Core ie;</span><br><span class="line">    <span class="comment">//查询支持硬件设备</span></span><br><span class="line">    std::vector&lt;std::string&gt; availableDev = ie.<span class="built_in">GetAvailableDevices</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;availableDev.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Openvino Supported Device Name: &quot;</span> &lt;&lt; availableDev[i].<span class="built_in">c_str</span>() &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加载检测模型</span></span><br><span class="line">    <span class="keyword">auto</span> cnnNetwork = ie.<span class="built_in">ReadNetwork</span>(_xml_path); </span><br><span class="line">    <span class="comment">//网络输入设置</span></span><br><span class="line">    <span class="function">InputsDataMap <span class="title">inputInfo</span><span class="params">(cnnNetwork.getInputsInfo())</span></span>;</span><br><span class="line">    InputInfo::Ptr&amp; input = inputInfo.<span class="built_in">begin</span>()-&gt;second;</span><br><span class="line">    _input_name = inputInfo.<span class="built_in">begin</span>()-&gt;first;</span><br><span class="line">    input-&gt;<span class="built_in">setPrecision</span>(Precision::FP32);</span><br><span class="line">    input-&gt;<span class="built_in">getInputData</span>()-&gt;<span class="built_in">setLayout</span>(Layout::NCHW);</span><br><span class="line">    ICNNNetwork::InputShapes inputShapes = cnnNetwork.<span class="built_in">getInputShapes</span>();</span><br><span class="line">    SizeVector&amp; inSizeVector = inputShapes.<span class="built_in">begin</span>()-&gt;second;</span><br><span class="line">    cnnNetwork.<span class="built_in">reshape</span>(inputShapes);</span><br><span class="line">    <span class="comment">//网络输出设置</span></span><br><span class="line">    _outputinfo = <span class="built_in">OutputsDataMap</span>(cnnNetwork.<span class="built_in">getOutputsInfo</span>());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;output : _outputinfo) &#123;</span><br><span class="line">        output.second-&gt;<span class="built_in">setPrecision</span>(Precision::FP32);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取可执行网络</span></span><br><span class="line">    <span class="comment">//_network =  ie.LoadNetwork(cnnNetwork, &quot;GPU&quot;);</span></span><br><span class="line">    _network =  ie.<span class="built_in">LoadNetwork</span>(cnnNetwork, <span class="string">&quot;CPU&quot;</span>);</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;Running on CPU\n&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意此处的阈值是框和物体prob乘积的阈值</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RobotDetector::parseYolov5</span><span class="params">(<span class="keyword">const</span> Blob::Ptr &amp;blob,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 <span class="keyword">float</span> cof_threshold,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::vector&lt;cv::Rect&gt;&amp; o_rect,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::vector&lt;<span class="keyword">float</span>&gt;&amp; o_rect_cof,</span></span></span><br><span class="line"><span class="params"><span class="function">                                 std::vector&lt;<span class="keyword">int</span>&gt; &amp;classId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//如果输入图像大小为[1,3,640,640],那么三个输出的尺寸为3*80*80*(4+1)*80 | 40*40 | 20*20</span></span><br><span class="line">    <span class="comment">//利用blob-&gt;getTensorDesc().getDims()获取输出头的参数，包括w,h,c,batch_size,class_num</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> net_grid_h = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(blob-&gt;<span class="built_in">getTensorDesc</span>().<span class="built_in">getDims</span>()[<span class="number">2</span>]);    <span class="comment">// 80/40/20</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> net_grid_w = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(blob-&gt;<span class="built_in">getTensorDesc</span>().<span class="built_in">getDims</span>()[<span class="number">3</span>]);    <span class="comment">// 80/40/20</span></span><br><span class="line">    <span class="comment">//const int batch_size = static_cast&lt;int&gt;(blob-&gt;getTensorDesc().getDims()[0]);    // batch_size</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> anchor_num = <span class="keyword">static_cast</span>&lt;<span class="keyword">int</span>&gt;(blob-&gt;<span class="built_in">getTensorDesc</span>().<span class="built_in">getDims</span>()[<span class="number">1</span>]);    <span class="comment">// anchor_num,3</span></span><br><span class="line">    <span class="comment">// const int item_size = static_cast&lt;int&gt;(blob-&gt;getTensorDesc().getDims()[4]);     // (4+1+class_num)</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> item_size = <span class="number">11</span>;<span class="comment">//item_size为 类别个数+5</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//std::cout &lt;&lt; &quot;item size: &quot; &lt;&lt; item_size &lt;&lt;std::endl;</span></span><br><span class="line">    <span class="comment">//std::cout &lt;&lt; &quot;anchor scale: &quot; &lt;&lt; net_grid_h &lt;&lt;std::endl;</span></span><br><span class="line">    <span class="comment">//std::cout &lt;&lt; &quot;net_grid_h : &quot; &lt;&lt; net_grid_h &lt;&lt;&quot;  net_grid_w: &quot;&lt;&lt;net_grid_w&lt;&lt;std::endl;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (net_grid_h != net_grid_w) </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="comment">//std::cout &lt;&lt; &quot;网格长宽不一致&quot; &lt;&lt;std::endl; </span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//根据输出的尺度，利用get_anchors方法获得相应的锚框</span></span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; anchors = <span class="built_in">get_anchors</span>(net_grid_h);</span><br><span class="line">    <span class="comment">//输出分类内存分配</span></span><br><span class="line">    LockedMemory&lt;<span class="keyword">const</span> <span class="keyword">void</span>&gt; blobMapped = as&lt;MemoryBlob&gt;(blob)-&gt;<span class="built_in">rmap</span>();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> *output_blob = blobMapped.as&lt;<span class="keyword">float</span> *&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> net_grid = net_grid_h;</span><br><span class="line">    std::<span class="keyword">size_t</span> gi = net_grid*item_size;</span><br><span class="line">    std::<span class="keyword">size_t</span> ggi = net_grid*gi;</span><br><span class="line">    std::<span class="keyword">size_t</span> anchor_n = anchor_num;</span><br><span class="line">    <span class="comment">//输出解析与预测框解码部分</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> n = <span class="number">0</span>; n &lt; anchor_num; ++n)</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; net_grid; ++i)</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; net_grid; ++j)&#123;</span><br><span class="line">                <span class="comment">//获取输出置信度</span></span><br><span class="line">                <span class="keyword">double</span> box_prob = <span class="built_in">sigmoid</span>(output_blob[n*ggi + i*gi + j*item_size + <span class="number">4</span>]);</span><br><span class="line">                              </span><br><span class="line">                <span class="keyword">if</span>(box_prob &lt; cof_threshold) </span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 获取输出目标框</span></span><br><span class="line">                <span class="comment">//注意此处输出为中心点坐标,需要转化为角点坐标</span></span><br><span class="line">                <span class="keyword">double</span> x = output_blob[n*ggi + i*gi + j*item_size + <span class="number">0</span>];</span><br><span class="line">                <span class="keyword">double</span> y = output_blob[n*ggi + i*gi + j*item_size + <span class="number">1</span>];</span><br><span class="line">                <span class="keyword">double</span> w = output_blob[n*ggi + i*gi + j*item_size + <span class="number">2</span>];</span><br><span class="line">                <span class="keyword">double</span> h = output_blob[n*ggi + i*gi + j*item_size+ <span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取输出类别索引</span></span><br><span class="line">                <span class="keyword">double</span> max_prob = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">int</span> idx=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> t = <span class="number">5</span>; t &lt; item_size; ++t)&#123;</span><br><span class="line">                    <span class="keyword">double</span> tp= <span class="built_in">sigmoid</span>(output_blob[n*ggi + i*gi + j*item_size + t]);</span><br><span class="line">                    <span class="keyword">if</span>(tp &gt; max_prob)&#123;</span><br><span class="line">                        max_prob = tp;</span><br><span class="line">                        idx = t<span class="number">-5</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">float</span> cof = box_prob * max_prob;</span><br><span class="line">                <span class="comment">//对于边框置信度小于阈值的边框,不关心其他数值,不进行计算减少计算量</span></span><br><span class="line">                <span class="keyword">if</span>(cof &lt; cof_threshold)  </span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//预测框解码</span></span><br><span class="line">                x = (<span class="built_in">sigmoid</span>(x)*<span class="number">2</span> - <span class="number">0.5</span> + j)*IMAGE_LEN_F/net_grid;</span><br><span class="line">                y = (<span class="built_in">sigmoid</span>(y)*<span class="number">2</span> - <span class="number">0.5</span> + i)*IMAGE_LEN_F/net_grid;</span><br><span class="line">                w = <span class="built_in">pow</span>(<span class="built_in">sigmoid</span>(w)*<span class="number">2</span>,<span class="number">2</span>) * anchors[n*<span class="number">2</span>];</span><br><span class="line">                h = <span class="built_in">pow</span>(<span class="built_in">sigmoid</span>(h)*<span class="number">2</span>,<span class="number">2</span>) * anchors[n*<span class="number">2</span> + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">double</span> r_x = x - w/<span class="number">2</span>;</span><br><span class="line">                <span class="keyword">double</span> r_y = y - h/<span class="number">2</span>;</span><br><span class="line">                cv::Rect rect = cv::<span class="built_in">Rect</span>(<span class="built_in">round</span>(r_x),<span class="built_in">round</span>(r_y),<span class="built_in">round</span>(w),<span class="built_in">round</span>(h));</span><br><span class="line">                <span class="comment">//将结果保存在vector中</span></span><br><span class="line">                o_rect.<span class="built_in">push_back</span>(rect);</span><br><span class="line">                o_rect_cof.<span class="built_in">push_back</span>(cof);</span><br><span class="line">                classId.<span class="built_in">push_back</span>(idx);</span><br><span class="line">            &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// if(o_rect.size() == 0) //如果没有结果 返回false，目前不采用</span></span><br><span class="line">    <span class="comment">//     return false;</span></span><br><span class="line">    <span class="comment">// else</span></span><br><span class="line">    <span class="comment">//     return true;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理图像获取结果</span></span><br><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">RobotDetector::process_frame</span><span class="params">(cv::Mat&amp; inframe,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  std::vector&lt;Object&gt;&amp; detected_objects)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(inframe.<span class="built_in">empty</span>())&#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;无效图片输入&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cv::Mat resize_img = <span class="built_in">letterBox</span>(inframe);</span><br><span class="line">    std::<span class="keyword">size_t</span> img_size = <span class="number">640</span> * <span class="number">640</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//建立推理请求</span></span><br><span class="line">    InferRequest infer_request = _network.<span class="built_in">CreateInferRequest</span>();</span><br><span class="line">    Blob::Ptr frameBlob = infer_request.<span class="built_in">GetBlob</span>(_input_name);</span><br><span class="line">    LockedMemory&lt;<span class="keyword">void</span>&gt; blobMapped = as&lt;MemoryBlob&gt;(frameBlob)-&gt;<span class="built_in">wmap</span>();</span><br><span class="line">    <span class="keyword">float</span>* blob_data = blobMapped.as&lt;<span class="keyword">float</span>*&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//nchw 将输入图像关联到Blob</span></span><br><span class="line">    <span class="keyword">for</span>(std::<span class="keyword">size_t</span> row = <span class="number">0</span>;row &lt;IMAGE_LEN;row++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(std::<span class="keyword">size_t</span> col =<span class="number">0</span>;col &lt;IMAGE_LEN;col++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(std::<span class="keyword">size_t</span> ch=<span class="number">0</span>;ch&lt;<span class="number">3</span>;ch++)&#123;</span><br><span class="line">                <span class="comment">//遍历输入图像的每个像素保存到blob_data，目前不理解blob_data的索引值</span></span><br><span class="line">                blob_data[img_size*ch + row*IMAGE_LEN + col] = <span class="built_in"><span class="keyword">float</span></span>(resize_img.at&lt;cv::Vec3b&gt;(row,col)[ch]/<span class="number">255.0f</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">    <span class="comment">//执行预测</span></span><br><span class="line">    infer_request.<span class="built_in">Infer</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取各层结果,保存到origin_rect,origin_rect_cof，classId</span></span><br><span class="line">    std::vector&lt;cv::Rect&gt; origin_rect;</span><br><span class="line">    std::vector&lt;<span class="keyword">float</span>&gt; origin_rect_cof;</span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; classId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//大规模计算之前先收集指针</span></span><br><span class="line">    std::vector&lt;Blob::Ptr&gt; blobs;</span><br><span class="line">    <span class="comment">//blobs保存推理结果，用于输入到parseYolov5方法进行解析</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;output : _outputinfo) &#123;</span><br><span class="line">        <span class="keyword">auto</span> output_name = output.first;</span><br><span class="line">        Blob::Ptr blob = infer_request.<span class="built_in">GetBlob</span>(output_name);</span><br><span class="line">        blobs.<span class="built_in">push_back</span>(blob);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//blob的大小为3</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;blobs.<span class="built_in">size</span>();i++)&#123;</span><br><span class="line">        <span class="keyword">float</span> th = <span class="number">0.5</span>;</span><br><span class="line">        <span class="comment">//<span class="doctag">TODO:</span>根据网格大小使用不同阈值，可自己调配</span></span><br><span class="line">        <span class="keyword">if</span>(i == <span class="number">0</span>) &#123; th = <span class="number">0.55</span>; &#125;  <span class="comment">//小目标严格要求</span></span><br><span class="line">        <span class="keyword">if</span>(i == <span class="number">1</span>) &#123; th = <span class="number">0.45</span>; &#125;  <span class="comment">//大目标放宽要求</span></span><br><span class="line">        <span class="keyword">if</span>(i == <span class="number">2</span>) &#123; th = <span class="number">0.40</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//用于保存解析结果的临时vector </span></span><br><span class="line">        std::vector&lt;cv::Rect&gt; origin_rect_temp;</span><br><span class="line">        std::vector&lt;<span class="keyword">float</span>&gt; origin_rect_cof_temp;</span><br><span class="line">        std::vector&lt;<span class="keyword">int</span>&gt; classId_temp;</span><br><span class="line">        <span class="comment">//解析blobs</span></span><br><span class="line">        <span class="built_in">parseYolov5</span>(blobs[i], th, origin_rect_temp, origin_rect_cof_temp, classId);</span><br><span class="line">        origin_rect.<span class="built_in">insert</span>(origin_rect.<span class="built_in">end</span>(), origin_rect_temp.<span class="built_in">begin</span>(), origin_rect_temp.<span class="built_in">end</span>());</span><br><span class="line">        origin_rect_cof.<span class="built_in">insert</span>(origin_rect_cof.<span class="built_in">end</span>(), origin_rect_cof_temp.<span class="built_in">begin</span>(), origin_rect_cof_temp.<span class="built_in">end</span>());</span><br><span class="line">        classId.<span class="built_in">insert</span>(classId.<span class="built_in">end</span>(), classId_temp.<span class="built_in">begin</span>(), classId_temp.<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//后处理获得最终检测结果</span></span><br><span class="line">    std::vector&lt;<span class="keyword">int</span>&gt; final_id;</span><br><span class="line">    cv::dnn::<span class="built_in">NMSBoxes</span>(origin_rect, origin_rect_cof, _cof_threshold, _nms_area_threshold, final_id);</span><br><span class="line">    <span class="comment">//根据final_id获取最终结果</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; final_id.<span class="built_in">size</span>(); ++i)&#123;</span><br><span class="line">        cv::Rect resize_rect= origin_rect[final_id[i]];</span><br><span class="line">        <span class="comment">//调用detect2origin方法将框映射到原图</span></span><br><span class="line">        cv::Rect rawrect = <span class="built_in">detect2origin</span>(resize_rect, _ratio, _topPad, _leftPad);</span><br><span class="line">        detected_objects.<span class="built_in">push_back</span>(Object&#123;</span><br><span class="line">            origin_rect_cof[final_id[i]],</span><br><span class="line">            classId[final_id[i]],</span><br><span class="line">            rawrect</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下为工具函数</span></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">RobotDetector::sigmoid</span><span class="params">(<span class="keyword">double</span> x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">1</span> / (<span class="number">1</span> + <span class="built_in">exp</span>(-x)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> anchorBig = <span class="number">640</span>/<span class="number">8</span>;            <span class="comment">//8倍下采样</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> anchorMid = <span class="number">640</span>/<span class="number">16</span>;           <span class="comment">//16倍下采样</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> anchorSml = <span class="number">640</span>/<span class="number">32</span>;           <span class="comment">//32倍下采样</span></span><br><span class="line"> <span class="comment">/*yolov5s.yaml内容</span></span><br><span class="line"><span class="comment"> anchors:</span></span><br><span class="line"><span class="comment">   - [10,13,16,30,32,23]        # P3/8</span></span><br><span class="line"><span class="comment">   - [30,61,62,45,59,119]       # P4/16</span></span><br><span class="line"><span class="comment">   - [116,90,156,198,373,326]   # P5/32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="keyword">const</span> <span class="keyword">int</span> aBig[<span class="number">6</span>] = &#123;<span class="number">10</span>,<span class="number">13</span>,<span class="number">16</span>,<span class="number">30</span>,<span class="number">32</span>,<span class="number">23</span>&#125;;</span><br><span class="line"> <span class="keyword">const</span> <span class="keyword">int</span> aMid[<span class="number">6</span>] = &#123;<span class="number">30</span>,<span class="number">61</span>,<span class="number">62</span>,<span class="number">45</span>,<span class="number">59</span>,<span class="number">119</span>&#125;;</span><br><span class="line"> <span class="keyword">const</span> <span class="keyword">int</span> aSml[<span class="number">6</span>] = &#123;<span class="number">116</span>,<span class="number">90</span>,<span class="number">156</span>,<span class="number">198</span>,<span class="number">373</span>,<span class="number">326</span>&#125;;</span><br><span class="line"><span class="comment">//获取锚框</span></span><br><span class="line"><span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">RobotDetector::get_anchors</span><span class="params">(<span class="keyword">int</span> net_grid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">std::vector&lt;<span class="keyword">int</span>&gt; <span class="title">anchors</span><span class="params">(<span class="number">6</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(net_grid == anchorBig) &#123; anchors.<span class="built_in">insert</span>(anchors.<span class="built_in">begin</span>(),aBig,aBig+<span class="number">6</span>); &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(net_grid == anchorMid) &#123; anchors.<span class="built_in">insert</span>(anchors.<span class="built_in">begin</span>(),aMid,aMid+<span class="number">6</span>); &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(net_grid == anchorSml) &#123; anchors.<span class="built_in">insert</span>(anchors.<span class="built_in">begin</span>(),aSml,aSml+<span class="number">6</span>); &#125;</span><br><span class="line">    <span class="keyword">return</span> anchors;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//图像缩放与填充</span></span><br><span class="line"><span class="function">cv::Mat <span class="title">RobotDetector::letterBox</span><span class="params">(cv::Mat src)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(src.<span class="built_in">empty</span>()) &#123; std::cout &lt;&lt;<span class="string">&quot;input image invalid&quot;</span> &lt;&lt; std::endl;  <span class="keyword">return</span> cv::<span class="built_in">Mat</span>();&#125;</span><br><span class="line">    <span class="comment">//以下为带边框图像生成</span></span><br><span class="line">    <span class="keyword">int</span> in_w = src.cols;</span><br><span class="line">    <span class="keyword">int</span> in_h = src.rows;</span><br><span class="line">    <span class="keyword">int</span> tar_w = <span class="number">640</span>;</span><br><span class="line">    <span class="keyword">int</span> tar_h = <span class="number">640</span>;</span><br><span class="line">    <span class="comment">//哪个缩放比例小选哪个</span></span><br><span class="line">    _ratio = std::<span class="built_in">min</span>(<span class="built_in"><span class="keyword">float</span></span>(tar_h)/in_h,<span class="built_in"><span class="keyword">float</span></span>(tar_w)/in_w);</span><br><span class="line">    <span class="keyword">int</span> inside_w = std::<span class="built_in">round</span>(in_w * _ratio);</span><br><span class="line">    <span class="keyword">int</span> inside_h = std::<span class="built_in">round</span>(in_h * _ratio);</span><br><span class="line">    <span class="keyword">int</span> pad_w = tar_w - inside_w;</span><br><span class="line">    <span class="keyword">int</span> pad_h = tar_h - inside_h;</span><br><span class="line">    <span class="comment">//内层图像resize</span></span><br><span class="line">    cv::Mat resize_img;</span><br><span class="line">    cv::<span class="built_in">resize</span>(src,resize_img,cv::<span class="built_in">Size</span>(inside_w,inside_h));  <span class="comment">//最小的Resize</span></span><br><span class="line">    cv::<span class="built_in">cvtColor</span>(resize_img,resize_img,cv::COLOR_BGR2RGB);</span><br><span class="line">    pad_w = pad_w / <span class="number">2</span>;</span><br><span class="line">    pad_h = pad_h / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">//外层边框填充灰色</span></span><br><span class="line">    _topPad = <span class="built_in"><span class="keyword">int</span></span>(std::<span class="built_in">round</span>(pad_h - <span class="number">0.1</span>));</span><br><span class="line">    _btmPad = <span class="built_in"><span class="keyword">int</span></span>(std::<span class="built_in">round</span>(pad_h + <span class="number">0.1</span>));</span><br><span class="line">    _leftPad = <span class="built_in"><span class="keyword">int</span></span>(std::<span class="built_in">round</span>(pad_w - <span class="number">0.1</span>));</span><br><span class="line">    _rightPad = <span class="built_in"><span class="keyword">int</span></span>(std::<span class="built_in">round</span>(pad_w + <span class="number">0.1</span>));</span><br><span class="line"></span><br><span class="line">    cv::<span class="built_in">copyMakeBorder</span>(resize_img,resize_img, _topPad, _btmPad, _leftPad, _rightPad,cv::BORDER_CONSTANT,cv::<span class="built_in">Scalar</span>(<span class="number">114</span>,<span class="number">114</span>,<span class="number">114</span>));</span><br><span class="line">    <span class="keyword">return</span> resize_img;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//还原  从detect得到的xywh转换回到原图xywh</span></span><br><span class="line"><span class="function">cv::Rect <span class="title">RobotDetector::detect2origin</span><span class="params">(<span class="keyword">const</span> cv::Rect &amp;det_rect, <span class="keyword">float</span> rate_to, <span class="keyword">int</span> top, <span class="keyword">int</span> left)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//detect坐标转换到内部纯图坐标</span></span><br><span class="line">    <span class="keyword">int</span> inside_x = det_rect.x - left;</span><br><span class="line">    <span class="keyword">int</span> inside_y = det_rect.y - top;</span><br><span class="line">    <span class="keyword">int</span> ox = std::<span class="built_in">round</span>(<span class="built_in"><span class="keyword">float</span></span>(inside_x)/rate_to);</span><br><span class="line">    <span class="keyword">int</span> oy = std::<span class="built_in">round</span>(<span class="built_in"><span class="keyword">float</span></span>(inside_y)/rate_to);</span><br><span class="line">    <span class="keyword">int</span> ow = std::<span class="built_in">round</span>(<span class="built_in"><span class="keyword">float</span></span>(det_rect.width)/rate_to);</span><br><span class="line">    <span class="keyword">int</span> oh = std::<span class="built_in">round</span>(<span class="built_in"><span class="keyword">float</span></span>(det_rect.height)/rate_to);</span><br><span class="line"></span><br><span class="line">    <span class="function">cv::Rect <span class="title">origin_rect</span><span class="params">(ox,oy,ow,oh)</span></span>;</span><br><span class="line">    <span class="keyword">return</span> origin_rect;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="3-运行结果"><a href="#3-运行结果" class="headerlink" title="3. 运行结果"></a>3. 运行结果</h2><p><img src="/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/3.png" alt="aaa"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Fun</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/">http://example.com/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">JiaFan's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/cover9_yolov5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/04/05/%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%8F%98%E6%8D%A2%E5%8F%AF%E8%A7%86%E5%8C%96/"><img class="prev-cover" src="/img/rotate_cover.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">三维旋转变换可视化</div></div></a></div><div class="next-post pull-right"><a href="/2022/03/29/%E3%80%90CMake%E3%80%91include_directories%E5%92%8Ctarget_include_directories/"><img class="next-cover" src="/img/cover7_cmake.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">【CMake】target_include_directories和target_include_directories</div></div></a></div></nav><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div><div id="comment-switch"><span class="first-comment">V</span><span class="switch-btn"></span><span class="second-comment">a</span></div></div><div class="comment-wrap"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Fun</div><div class="author-info__description">自动挡驾驶研究爱好者，全干工程师</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">11</div></a></div></div><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/hitxjf" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:xujiafan.hit@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.</span> <span class="toc-text">利用OpenVino部署yolov5模型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-OpenVINO%E7%9A%84%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">1. OpenVINO的安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Step1-%E4%B8%8B%E8%BD%BD%E5%AE%8C%E6%88%90%E5%90%8E%EF%BC%8C%E8%A7%A3%E5%8E%8B%E5%AE%89%E8%A3%85%E5%8C%85%EF%BC%8C"><span class="toc-number">1.1.0.1.</span> <span class="toc-text">Step1 下载完成后，解压安装包，</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.0.2.</span> <span class="toc-text">Step2 安装依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step3-%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.0.3.</span> <span class="toc-text">Step3 环境变量设置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Step4-%E6%B5%8B%E8%AF%95%E6%98%AF%E5%90%A6%E5%AE%89%E8%A3%85%E6%88%90%E5%8A%9F"><span class="toc-number">1.1.0.4.</span> <span class="toc-text">Step4 测试是否安装成功</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-yolov5%E6%A8%A1%E5%9E%8B%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.</span> <span class="toc-text">2. yolov5模型的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-CMakeLists-txt"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">2.1 CMakeLists.txt</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-yolov5-openvino-cpp"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">2.2 yolov5_openvino.cpp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-3-RobotDetector-h"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">2.3 RobotDetector.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-4-RobotDetector-cpp"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">2.4 RobotDetector.cpp</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C"><span class="toc-number">1.3.</span> <span class="toc-text">3. 运行结果</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/04/12/Ceres%E4%BC%98%E5%8C%96%E5%BA%93%E2%80%94%E8%87%AA%E5%8A%A8%E6%B1%82%E5%AF%BC%E4%B8%8E%E8%A7%A3%E6%9E%90%E6%B1%82%E5%AF%BC%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="Ceres优化库—自动求导与解析求导的实现"><img src="/img/ceres_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Ceres优化库—自动求导与解析求导的实现"/></a><div class="content"><a class="title" href="/2022/04/12/Ceres%E4%BC%98%E5%8C%96%E5%BA%93%E2%80%94%E8%87%AA%E5%8A%A8%E6%B1%82%E5%AF%BC%E4%B8%8E%E8%A7%A3%E6%9E%90%E6%B1%82%E5%AF%BC%E7%9A%84%E5%AE%9E%E7%8E%B0/" title="Ceres优化库—自动求导与解析求导的实现">Ceres优化库—自动求导与解析求导的实现</a><time datetime="2022-04-12T05:00:00.000Z" title="发表于 2022-04-12 13:00:00">2022-04-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/04/05/%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%8F%98%E6%8D%A2%E5%8F%AF%E8%A7%86%E5%8C%96/" title="三维旋转变换可视化"><img src="/img/rotate_cover.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="三维旋转变换可视化"/></a><div class="content"><a class="title" href="/2022/04/05/%E4%B8%89%E7%BB%B4%E6%97%8B%E8%BD%AC%E5%8F%98%E6%8D%A2%E5%8F%AF%E8%A7%86%E5%8C%96/" title="三维旋转变换可视化">三维旋转变换可视化</a><time datetime="2022-04-05T04:33:31.000Z" title="发表于 2022-04-05 12:33:31">2022-04-05</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/" title="利用OpenVino部署yolov5模型"><img src="/img/cover9_yolov5.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用OpenVino部署yolov5模型"/></a><div class="content"><a class="title" href="/2022/03/29/%E5%88%A9%E7%94%A8OpenVino%E9%83%A8%E7%BD%B2yolov5%E6%A8%A1%E5%9E%8B/" title="利用OpenVino部署yolov5模型">利用OpenVino部署yolov5模型</a><time datetime="2022-03-29T14:00:00.000Z" title="发表于 2022-03-29 22:00:00">2022-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/29/%E3%80%90CMake%E3%80%91include_directories%E5%92%8Ctarget_include_directories/" title="【CMake】target_include_directories和target_include_directories"><img src="/img/cover7_cmake.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="【CMake】target_include_directories和target_include_directories"/></a><div class="content"><a class="title" href="/2022/03/29/%E3%80%90CMake%E3%80%91include_directories%E5%92%8Ctarget_include_directories/" title="【CMake】target_include_directories和target_include_directories">【CMake】target_include_directories和target_include_directories</a><time datetime="2022-03-29T05:00:00.000Z" title="发表于 2022-03-29 13:00:00">2022-03-29</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/03/25/%E5%88%A9%E7%94%A8OpenCV%E4%BB%8E%E4%B8%80%E6%AE%B5%E8%A7%86%E9%A2%91%E4%B8%AD%E6%8F%90%E5%8F%96%E5%9B%BE%E7%89%87/" title="利用OpenCV从一段视频中提取图片"><img src="/img/cover8_opencv.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="利用OpenCV从一段视频中提取图片"/></a><div class="content"><a class="title" href="/2022/03/25/%E5%88%A9%E7%94%A8OpenCV%E4%BB%8E%E4%B8%80%E6%AE%B5%E8%A7%86%E9%A2%91%E4%B8%AD%E6%8F%90%E5%8F%96%E5%9B%BE%E7%89%87/" title="利用OpenCV从一段视频中提取图片">利用OpenCV从一段视频中提取图片</a><time datetime="2022-03-25T09:00:00.000Z" title="发表于 2022-03-25 17:00:00">2022-03-25</time></div></div></div></div></div></div></main><footer id="footer" style="background: #778899"><div id="footer-wrap"><div class="copyright">&copy;2022 By Fun</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font-plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font-minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>